# Subgraph

## 概要
Subgraphノードは、別のPCGグラフを現在のグラフ内で実行します。グラフの再利用性とモジュール性を高め、複雑なPCGシステムを構造化された方法で構築できます。

- **ノードタイプ**: Subgraph
- **クラス**: `UPCGSubgraphSettings`
- **エレメント**: `FPCGSubgraphElement`
- **ノード**: `UPCGSubgraphNode`

## 機能詳細
このノードは、別のPCGグラフを埋め込み実行します。サブグラフの入力ピンと出力ピンは、親グラフで自動的に利用可能になります。サブグラフのパラメータもオーバーライド可能です。

### 主な機能
- **グラフの再利用**: 共通の処理を複数のグラフで共有
- **動的サブグラフ**: 実行時にサブグラフをオーバーライド可能
- **パラメータオーバーライド**: サブグラフのパラメータを親グラフから設定
- **入出力の自動転送**: サブグラフのピンが自動的に公開される
- **静的/動的モード**: グラフのインライン化または動的実行を選択
- **グラフインスタンス**: サブグラフごとに独立したパラメータインスタンス

### 処理フロー
1. サブグラフインスタンスまたはオーバーライドからグラフを取得
2. 入力データをサブグラフの入力ピンに転送
3. パラメータオーバーライドを適用
4. サブグラフを実行
5. サブグラフの出力を親グラフの出力に転送

## プロパティ

### SubgraphInstance
- **型**: UPCGGraphInstance*（Instanced）
- **カテゴリ**: Properties
- **アクセス**: BlueprintReadOnly, VisibleAnywhere
- **メタ**: NoResetToDefault
- **説明**: サブグラフのインスタンス。パラメータ値を保持します

### SubgraphOverride
- **型**: UPCGGraphInterface*
- **カテゴリ**: Properties
- **アクセス**: BlueprintReadOnly
- **PCG_Overridable**: あり
- **説明**: 実行時にサブグラフをオーバーライドします。設定されている場合、SubgraphInstanceの代わりに使用されます

## 使用例

### 基本的なサブグラフ使用
```
// 単純なサブグラフの呼び出し
SubgraphInstance: [G_TreePlacement選択]
結果: G_TreePlacementグラフが現在の位置で実行される
```

### パラメータ付きサブグラフ
```
// パラメータをオーバーライド
SubgraphInstance: [G_ProceduralBuilding選択]
パラメータオーバーライド:
  - Height: 50.0
  - Width: 30.0
  - Floors: 5
結果: 指定されたパラメータでビルディンググラフが実行される
```

### 動的サブグラフ選択
```
// 実行時にサブグラフを切り替え
SubgraphOverride: [属性またはパラメータから取得]
結果: 動的に選択されたグラフが実行される
```

### 再利用可能なモジュール
```
// 共通処理のモジュール化
// G_Denoise グラフを作成し、複数のグラフで使用
SubgraphInstance: [G_Denoise選択]
入力: ノイズを含むポイントデータ
結果: デノイズ処理された結果が返される
```

### ネストされたサブグラフ
```
// サブグラフの中でさらにサブグラフを使用
// G_MasterLayout -> G_DistrictLayout -> G_BuildingPlacement
各レベルで処理を階層化し、管理しやすい構造を構築
```

## 実装の詳細

### 基底クラス
- **Settings**: `UPCGBaseSubgraphSettings`を継承
- **Element**: `IPCGElement`を継承（`FPCGSubgraphElement`として実装）
- **Node**: `UPCGBaseSubgraphNode`を継承

### 入出力ピン
入出力ピンは、サブグラフのInputノードとOutputノードから自動的に生成されます：
- **入力ピン**: サブグラフの各Inputノードに対応
- **出力ピン**: サブグラフの各Outputノードに対応

### 処理の特徴
- **前タスクデータ必要**: `RequiresDataFromPreTask()` が `true` を返す
- **タイトル行の反転**: `HasFlippedTitleLines()` が `true` を返す
- **カリング不可**: `CanCullTaskIfUnwired()` が `false` を返す（副作用がある可能性があるため）
- **キャッシュ不可**: `IsCacheable()` が `false` を返す
- **動的キー追跡**: `CanDynamicallyTrackKeys()` が `true` を返す

### コンテキスト
`FPCGSubgraphContext` を使用して、以下を管理します：
- サブグラフのタスクID
- パラメータオーバーライド
- 参照されるオブジェクト

### 静的 vs 動的グラフ
- **静的グラフ**: コンパイル時にサブグラフがインライン化され、最適化されます
- **動的グラフ**: `IsDynamicGraph()` が `true` を返す場合、実行時に動的に解決されます

### パラメータオーバーライド
親グラフからサブグラフのパラメータをオーバーライドできます：
1. 属性データからのオーバーライド
2. パラメータノードからのオーバーライド
3. SubgraphOverrideからの追加オーバーライド

## パフォーマンス考慮事項

1. **グラフのインライン化**: 静的グラフはインライン化され、オーバーヘッドが最小化されます
2. **動的解決**: SubgraphOverrideを使用すると、動的解決のオーバーヘッドが発生します
3. **サブグラフの複雑度**: サブグラフが複雑なほど実行時間が増加します
4. **ネストの深さ**: 深くネストされたサブグラフは管理とデバッグが困難になります
5. **パラメータオーバーライド**: 大量のオーバーライドはわずかなオーバーヘッドを追加します

## 注意事項

1. **循環参照**: サブグラフが直接的または間接的に自分自身を参照しないようにしてください
2. **ピン互換性**: サブグラフの入出力ピンの型は、接続される親グラフのピンと互換性がある必要があります
3. **パラメータ型**: オーバーライドするパラメータの型は、サブグラフで定義された型と一致する必要があります
4. **グラフの有効性**: SubgraphInstanceまたはSubgraphOverrideは有効なPCGグラフを参照する必要があります
5. **デバッグの複雑性**: ネストされたサブグラフはデバッグが困難になる場合があります
6. **パフォーマンス監視**: 深くネストされたサブグラフはパフォーマンスを監視してください

## エディタ機能

### グラフのダブルクリック
サブグラフノードをダブルクリックすると、参照されているグラフが開きます（`GetJumpTargetForDoubleClick()` 実装）。

### ノードタイトル
`GetAdditionalTitleInformation()` により、サブグラフの名前がノードタイトルに表示されます。

### ノードカラー
`GetNodeTitleColor()` により、サブグラフノードは特別な色で表示されます。

### 変更追跡
サブグラフの変更は自動的に親グラフに伝播され、適切な再生成がトリガーされます。

## サブグラフの設計パターン

### 1. ユーティリティグラフ
共通の処理（デノイズ、フィルタリング、正規化など）を独立したグラフとして実装。

### 2. コンポーネントグラフ
再利用可能なコンポーネント（木、岩、建物など）を個別のグラフとして定義。

### 3. レイヤーグラフ
レイヤーごとに処理を分離（地形、植生、構造物など）。

### 4. バリエーショングラフ
パラメータによって動作が変わるグラフを作成し、異なる設定で再利用。

### 5. マスターグラフ
複数のサブグラフを組み合わせて、大規模なシステムを構築。

## 関連ノード
- **Loop**: サブグラフを繰り返し実行
- **Spawn Actor**: アクターをスポーンし、そのPCGコンポーネントをサブグラフとして実行
- **Input/Output**: サブグラフの入出力を定義
- **Get/Set Parameter**: サブグラフのパラメータを操作

## 実装ファイル
- **ヘッダー**: `Engine/Plugins/PCG/Source/PCG/Public/PCGSubgraph.h`
- **実装**: `Engine/Plugins/PCG/Source/PCG/Private/PCGSubgraph.cpp`
